---
layout : post
category : manage
tags : [Linux]
title : Linux 系统优化之Memory
---



### 2. 内存性能评估
 
	内存的管理和优化是系统性能优化的一个重要部分，内存资源的充足与否直接影响应用系统的使用性能，在进行内存优化之前，一定要熟悉linux的内存管理机制，这一点我们在前面的章节已经有深入讲述，本节的重点是如何通过系统命令监控linux系统的内存使用状况。

#### 2.1 free 命令
	free是监控linux内存使用状况最常用的指令，看下面的一个输出：

	[root@webserver ~]# free -m
				total       used       free     shared    buffers     cached
	Mem:          8111       7185        925          0        243       6299
	-/+ buffers/cache:        643       7468
	Swap:         8189          0       8189
  
	“free –m”表示以M为单位查看内存使用情况，在这个输出中，重点关注的应该是free列与cached列的输出值，由输出可知，此系统共8G内存，系统空闲内存还有925M，其中，Buffer Cache占用了243M，Page Cache占用了6299M，由此可知系统缓存了很多的文件和目录，而对于应用程序来说，可以使用的内存还有7468M，当然这个7468M包含了Buffer Cache和Page Cache的值。在swap项可以看出，交换分区还未使用。所以从应用的角度来说，此系统内存资源还非常充足。
	一般有这样一个经验公式：应用程序可用内存/系统物理内存>70%时，表示系统内存资源非常充足，不影响系统性能，应用程序可用内存/系统物理内存<20%时，表示系统内存资源紧缺，需要增加系统内存，20%<应用程序可用内存/系统物理内存<70%时，表示系统内存资源基本能满足应用需求，暂时不影响系统性能。
	free命令还可以适时的监控内存的使用状况，使用“-s”参数可以在指定的时间段内不间断的监控内存的使用情况：
	
	[root@webserver ~]# free -b -s 5
			total       used       free     shared    buffers     cached
	Mem:    8505901056 7528706048  977195008          0  260112384 6601158656
	-/+ buffers/cache:  667435008 7838466048
	Swap:   8587149312     163840 8586985472

             total       used       free     shared    buffers     cached
	Mem:    8505901056 7526936576  978964480          0  260128768 6601142272
	-/+ buffers/cache:  665665536 7840235520
	Swap:   8587149312     163840 8586985472

             total       used       free     shared    buffers     cached
	Mem:    8505901056 7523987456  981913600          0  260141056 6601129984
	-/+ buffers/cache:  662716416 7843184640
	Swap:   8587149312     163840 8586985472
	
	其中，“-b”表示以千字节(也就是1024字节为单位)来显示内存使用情况。

#### 2.2 通过watch与free相结合动态监控内存状况

	watch是一个非常有用的命令，几乎每个linux发行版都带有这个工具，通过watch，可以动态的监控命令的运行结果，省去手动执行的麻烦。
	可以在watch后面跟上需要运行的命令，watch就会自动重复去运行这个命令，默认是2秒钟执行一次，并把执行的结果更新在屏幕上。例如：
	
	[root@webserver ~]# watch -n 3 -d free
	Every 3.0s: free                                   Sun Nov 30 16:23:20 2008

				total       used       free     shared    buffers     cached
	Mem:       8306544    7349548     956996          0     203296    6500024
	-/+ buffers/cache:     646228    7660316
	Swap:      8385888        160    8385728
	
其中，“-n”指定重复执行的时间，“-d”表示高亮显示变动。

#### 2.3 vmstat 命令监控内存

	vmstat命令在监控系统内存方面功能强大，请看下面的一个输出：
	
	procs  -----------memory----------  ---swap--  -----io---- --system--   ----cpu----
	r  b   swpd    free buff    cache   si   so    bi    bo    in    cs    us sy id   wa
	0  0  906440  22796 155616 1325496  340  180    2     4     1     4    80  0  10  10
	0  0  906440  42796 155616 1325496  320  289    0    54    1095  287   70  15  0  15
	0  0  906440  42884 155624 1325748  236  387    2   102    1064   276  78  2   5  15

	对于内存的监控，在vmstat中重点关注的是swpd、si和so行，从这个输出可以看出，此系统内存资源紧缺，swpd占用了900M左右内存，si和so占用很大，而由于系统内存的紧缺，导致出现15%左右的系统等待，此时增加系统的内存是必须要做的。

#### 2.4 sar -r命令组合
	
	sar命令也可以监控linux的内存使用状况，可以通过“sar –r”组合查看系统内存和交换空间的使用率。请看下面的一个输出：
 
	[root@webserver ~]# sar -r 2 3
	Linux 2.6.9-42.ELsmp (webserver)        11/30/2008      _i686_  (8 CPU)

	09:57:33 PM kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit
	09:57:35 PM    897988   7408556     89.19    249428   6496532    786556      4.71
	09:57:37 PM    898564   7407980     89.18    249428   6496532    784276      4.70
	09:57:39 PM    899196   7407348     89.17    249440   6496520    782132      4.69
	Average:       898583   7407961     89.18    249432   6496528    784321      4.70
	
	其中：
	Kbmemfree表示空闲物理内存大小，kbmemused表示已使用的物理内存空间大小，%memused表示已使用内存占总内存大小的百分比，kbbuffers和kbcached分别表示Buffer Cache和Page Cache的大小，kbcommit和%commit分别表示应用程序当前使用的内存大小和使用百分比。
	可以看出sar的输出其实与free的输出完全对应，不过sar更加人性化，不但给出了内存使用量，还给出了内存使用的百分比以及统计的平均值。从%commit项可知，此系统目前内存资源充足。